#!/bin/bash

PORT=9004
PID_FILE=~/.xdebug_socat.pid
WSL_HOST_IP=$(grep -m1 nameserver /etc/resolv.conf | awk '{print $2}')

case "$1" in
  start)
    if [ -f "$PID_FILE" ] && kill -0 "$(cat $PID_FILE)" 2>/dev/null; then
      echo "‚ö†Ô∏è Socat —É–∂–µ –∑–∞–ø—É—â–µ–Ω —Å PID $(cat $PID_FILE)"
      exit 0
    fi
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é socat –Ω–∞ –ø–æ—Ä—Ç—É $PORT..."
    socat TCP-LISTEN:$PORT,fork TCP:$WSL_HOST_IP:$PORT & echo $! > "$PID_FILE"
    echo "‚úÖ Socat –∑–∞–ø—É—â–µ–Ω (PID $(cat $PID_FILE))"
    ;;

  stop)
    if [ ! -f "$PID_FILE" ]; then
      echo "‚ö†Ô∏è PID-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. Socat, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ –∑–∞–ø—É—â–µ–Ω."
      exit 1
    fi
    PID=$(cat "$PID_FILE")
    echo "‚õî –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é socat (PID $PID)..."
    kill $PID && rm "$PID_FILE" && echo "‚úÖ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ." || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å socat."
    ;;

  *)
    echo "‚ùì –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 {start|stop}"
    exit 1
    ;;
esac
